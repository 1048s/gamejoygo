name: KaneDefense Ultimate Path Fix

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # 1. Desktop 빌드 (Windows, Linux, macOS)
  build-desktop:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: KaneDefense-Win.exe
            sep: ";"
          - os: ubuntu-latest
            artifact_name: KaneDefense-Linux
            sep: ":"
          - os: macos-latest
            artifact_name: KaneDefense-Mac
            sep: ":"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pygame Pillow
          # requirements.txt가 있으면 설치, 없으면 통과
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build Executable
        shell: bash
        run: |
          python -c "
          import PyInstaller.__main__; import os; import sys;
          sep = '${{ matrix.sep }}';
          
          # 1. 파일 경로 자동 탐색 로직 (루트 또는 code 폴더 확인)
          possible_targets = ['main.py', os.path.join('code', 'main.py')]
          target = None
          for t in possible_targets:
              if os.path.exists(t):
                  target = t
                  break
          
          if not target:
              print('--- Error: main.py not found in root or code/ folder! ---')
              os.system('ls -R') # 디버깅을 위해 전체 구조 출력
              sys.exit(1)
          
          print(f'--- Starting build for: {target} ---')
          
          # 2. 리소스 경로 설정
          base_dir = os.path.dirname(target) if os.path.dirname(target) else '.'
          img_src = os.path.join(base_dir, 'image')
          snd_src = os.path.join(base_dir, 'sound')
          
          opts = [target, '--onefile', '--noconsole', '--name=${{ matrix.artifact_name }}', '--clean'];
          
          if os.path.exists(img_src): opts.append(f'--add-data={img_src}{sep}image')
          if os.path.exists(snd_src): opts.append(f'--add-data={snd_src}{sep}sound')
          if os.path.exists('icon.ico'): opts.append('--icon=icon.ico')
          
          PyInstaller.__main__.run(opts)
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-desktop
          path: dist/